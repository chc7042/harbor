# PRD: Harbor 파일 다운로드 시스템 전면 재설계

## 개요

Harbor 시스템의 파일 다운로드 기능에서 발생하는 근본적인 문제들을 해결하기 위한 전면 재설계가 필요합니다. 현재 2.0.0 버전 파일(520MB) 다운로드 실패, 코드 수정사항 미반영, 사용자 경험 저하 등의 문제가 지속적으로 발생하고 있습니다.

## 목표

### 주요 목표
1. **즉시 다운로드 시작**: NAS 공유폴더와 동일한 수준의 즉시 반응 (1초 이내 다운로드 시작)
2. **통합된 다운로드 시스템**: 모든 다운로드를 단일 메커니즘으로 통합
3. **안정적인 배포 프로세스**: 코드 수정사항이 확실히 반영되는 배포 시스템
4. **보안 유지**: JWT 인증을 통한 접근 제어 유지

### 성능 목표
- 다운로드 시작 시간: 1초 이내
- 다운로드 성공률: 99% 이상
- 대용량 파일 (500MB+) 지원
- 동시 다운로드 10개 이상 처리

## 사용자 스토리

### 핵심 사용자 스토리
1. **즉시 다운로드**: 사용자로서 다운로드 버튼을 클릭하면 버퍼링 없이 즉시 다운로드가 시작되기를 원합니다.
2. **대용량 파일 다운로드**: 사용자로서 520MB 이상의 대용량 파일도 안정적으로 다운로드하고 싶습니다.
3. **일관된 경험**: 사용자로서 모든 파일 다운로드가 동일한 방식으로 동작하기를 원합니다.
4. **네트워크 안정성**: 사용자로서 네트워크가 불안정해도 다운로드가 중단되지 않기를 원합니다.

## 기능 요구사항

### 1. 통합 다운로드 아키텍처
1.1. 모든 다운로드를 단일 엔드포인트로 통합 (`/api/files/download`)
1.2. JWT 토큰 기반 인증 (헤더 또는 쿼리 파라미터)
1.3. 즉시 리다이렉트 방식으로 NAS 직접 URL 제공
1.4. 다단계 폴백 체인 (Synology Direct → Share Link → NAS Service)

### 2. 프론트엔드 통합
2.1. DeploymentTable과 ProjectDetailModal에서 동일한 다운로드 함수 사용
2.2. 브라우저 직접 다운로드 방식 (a 태그 클릭)
2.3. JWT 토큰 자동 포함
2.4. 에러 처리 및 사용자 피드백

### 3. 백엔드 최적화
3.1. 스트리밍 대신 302 리다이렉트 방식
3.2. NAS 직접 URL 생성 및 제공
3.3. 인증 미들웨어 개선 (쿼리 파라미터 지원)
3.4. 포괄적인 로깅 및 디버깅

### 4. 배포 프로세스 개선
4.1. 컨테이너 완전 재빌드 및 재배포
4.2. 코드 변경사항 확실한 반영
4.3. 실시간 로그 모니터링
4.4. 배포 검증 체크리스트

## 비목표 (범위 외)

1. 다운로드 진행률 표시 (브라우저 기본 기능 사용)
2. 다운로드 일시정지/재개 기능
3. 파일 미리보기 기능
4. 다운로드 히스토리 관리
5. 모바일 앱 지원
6. 기존 NAS 파일 구조 변경

## 설계 고려사항

### UI/UX 요구사항
- 다운로드 버튼 클릭 시 즉시 반응
- 에러 발생 시 명확한 메시지 표시
- 로딩 상태 최소화 (1초 이내)
- 브라우저 기본 다운로드 UI 활용

### 보안 요구사항
- JWT 토큰 기반 인증 유지
- CORS 정책 준수
- 임시 토큰 방식 고려 (보안 강화)
- 사용자별 접근 권한 확인

## 기술적 고려사항

### 현재 문제점
1. **이중 다운로드 시스템**: DeploymentTable과 ProjectDetailModal이 서로 다른 방식 사용
2. **인증 불일치**: 브라우저 직접 링크에서 JWT 토큰 누락
3. **배포 문제**: 코드 수정사항이 컨테이너에 반영되지 않음
4. **성능 문제**: 스트리밍 방식으로 인한 버퍼링 발생

### 해결 방안
1. **통합 다운로드 서비스**: 단일 API 엔드포인트와 프론트엔드 함수
2. **리다이렉트 패턴**: 인증 후 NAS 직접 URL로 302 리다이렉트
3. **배포 프로세스 개선**: 컨테이너 완전 재생성 및 캐시 무효화
4. **포괄적 로깅**: 각 단계별 상세 로그 및 디버깅 정보

### 종속성
- Synology NAS API 연동 유지
- Express.js 백엔드 라우터 구조
- React 프론트엔드 컴포넌트 아키텍처
- Docker Compose 배포 환경
- JWT 인증 시스템

## 성공 지표

### 즉시 측정 가능한 지표
- 2.0.0 버전 파일 다운로드 성공률: 100%
- 다운로드 시작 시간: 평균 1초 이하
- 401 인증 에러 발생률: 0%
- 코드 배포 후 변경사항 반영률: 100%

### 사용자 경험 지표
- 다운로드 관련 지원 요청 감소: 80% 이상
- 대용량 파일 다운로드 완료율: 95% 이상
- 동시 다운로드 처리 성공률: 99% 이상

### 시스템 안정성 지표
- 다운로드 API 응답 시간: 500ms 이하
- 시스템 에러율: 1% 이하
- 네트워크 타임아웃 복구율: 90% 이상

## 미해결 질문

1. **임시 토큰 시스템**: 보안 강화를 위한 단기 다운로드 토큰 도입 여부
2. **캐싱 전략**: NAS URL 캐싱을 통한 성능 최적화 방안
3. **모니터링**: 다운로드 성공률 및 성능 메트릭 수집 방법
4. **폴백 전략**: Synology API 장애 시 대체 다운로드 방법
5. **배포 자동화**: 코드 변경사항 자동 반영을 위한 CI/CD 개선 방안

## 구현 우선순위

### Phase 1: 긴급 수정 (1주일)
1. 배포 프로세스 문제 해결
2. 2.0.0 버전 다운로드 기능 복구
3. 인증 시스템 통합

### Phase 2: 시스템 통합 (2주일)
1. 통합 다운로드 API 구현
2. 프론트엔드 컴포넌트 통합
3. 리다이렉트 패턴 적용

### Phase 3: 성능 최적화 (1주일)
1. 대용량 파일 처리 최적화
2. 동시 다운로드 성능 개선
3. 에러 처리 강화

### Phase 4: 모니터링 및 개선 (지속적)
1. 성능 메트릭 수집
2. 사용자 피드백 반영
3. 추가 최적화 작업