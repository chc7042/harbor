# PRD: Harbor 파일 다운로드 시스템 근본 문제 해결

## 문제 정의

### 핵심 문제들
1. **다운로드 메커니즘 이중화**: 서로 다른 2개의 다운로드 시스템이 혼재
   - DeploymentTable: 브라우저 직접 링크 방식 (JWT 토큰 미포함)
   - ProjectDetailModal: API를 통한 downloadFile 함수 방식
   
2. **JWT 인증 실패**: 브라우저 직접 링크에서 Authorization 헤더 누락
   - 링크 클릭 시 자동으로 JWT 토큰이 전달되지 않음
   - 401 Unauthorized 에러 지속 발생

3. **코드 수정사항 반영 실패**: 반복적인 빌드에도 이전 코드 실행
   - 디버그 로그가 보이지 않음
   - 수정된 라우터 로직이 실행되지 않음

4. **사용자 경험 불일치**: 
   - 일부 다운로드는 즉시 시작 (NAS 직접 접근)
   - 일부 다운로드는 버퍼링 후 시작 (Harbor API 경유)

## 목표

### 주요 목표
1. **통일된 다운로드 시스템**: 모든 다운로드를 단일 메커니즘으로 통합
2. **즉시 다운로드 시작**: 사용자 클릭 즉시 다운로드 개시 (버퍼링 없음)
3. **보안 유지**: JWT 인증을 통한 접근 제어 유지
4. **코드 신뢰성**: 수정사항이 확실히 반영되는 배포 프로세스

### 성능 목표
- 다운로드 시작 시간: 1초 이내
- 대용량 파일 (500MB+) 지원
- 네트워크 중단 시 재개 가능

## 해결 방안

### 1. 통합 다운로드 아키텍처

#### 방안 A: 인증 토큰 포함 리다이렉트 방식
```
사용자 클릭 → Harbor API (JWT 인증) → NAS 직접 URL 리다이렉트 → 즉시 다운로드 시작
```

**구현 방법:**
- JWT 토큰을 쿼리 파라미터로 전달
- 백엔드에서 토큰 검증 후 302 리다이렉트
- 직접 NAS URL로 즉시 다운로드

**장점:**
- 즉시 다운로드 시작
- 보안 유지
- 서버 리소스 절약

**단점:**
- URL에 토큰 노출 (짧은 시간)

#### 방안 B: 임시 다운로드 토큰 방식
```
사용자 클릭 → 임시 토큰 생성 → 임시 토큰으로 다운로드 URL 생성 → 다운로드
```

**구현 방법:**
- 단기 유효 임시 다운로드 토큰 생성 (5분)
- 임시 토큰으로 인증된 다운로드 엔드포인트
- 토큰 만료 후 자동 무효화

**장점:**
- 보안성 높음
- 토큰 재사용 방지
- 로그 추적 가능

**단점:**
- 복잡도 증가
- 추가 DB 테이블 필요

### 2. 코드 신뢰성 확보

#### 문제 분석
- Docker 이미지 빌드는 성공하지만 이전 코드 실행
- 컨테이너 내부 파일은 수정되어 있음
- 라우터 등록 순서나 미들웨어 문제 의심

#### 해결 방안
1. **라우터 등록 순서 확인**: files.js 라우터가 다른 라우터보다 먼저 등록되도록
2. **미들웨어 체인 검증**: authenticateToken 미들웨어가 정상 동작하는지 확인
3. **컨테이너 완전 재시작**: 이미지 빌드 후 컨테이너 삭제/재생성
4. **실시간 디버깅**: 컨테이너 내부에서 직접 로그 확인

### 3. 통합 프론트엔드 인터페이스

#### 현재 문제
- DeploymentTable: `link.href = artifact.downloadUrl`
- ProjectDetailModal: `downloadFile(downloadUrl, fileName)`

#### 통합 방안
```javascript
// 통합 다운로드 함수
const handleDownload = async (downloadUrl, fileName) => {
  // 1. 임시 다운로드 토큰 생성
  const token = await generateDownloadToken(downloadUrl);
  
  // 2. 토큰 포함 URL 생성
  const authenticatedUrl = `${downloadUrl}?token=${token}`;
  
  // 3. 브라우저 직접 다운로드
  const link = document.createElement('a');
  link.href = authenticatedUrl;
  link.download = fileName;
  link.click();
};
```

## 구현 계획

### Phase 1: 근본 문제 해결 (우선순위: 높음)
1. **라우터 디버깅**
   - 현재 라우터 등록 순서 확인
   - 미들웨어 실행 로그 추가
   - 요청 경로 추적 로그

2. **인증 메커니즘 수정**
   - JWT 토큰 쿼리 파라미터 지원 추가
   - 백엔드 인증 미들웨어 수정
   - 토큰 검증 로직 강화

### Phase 2: 다운로드 시스템 통합 (우선순위: 높음)
1. **임시 다운로드 토큰 시스템**
   - 토큰 생성 API 엔드포인트
   - 토큰 검증 미들웨어
   - 만료 시간 관리

2. **프론트엔드 통합**
   - 통합 다운로드 함수 개발
   - DeploymentTable 수정
   - ProjectDetailModal 수정

### Phase 3: 사용자 경험 개선 (우선순위: 중간)
1. **다운로드 진행률 표시**
2. **에러 처리 개선**
3. **대용량 파일 최적화**

### Phase 4: 모니터링 및 분석 (우선순위: 낮음)
1. **다운로드 성공률 추적**
2. **성능 메트릭 수집**
3. **사용자 행동 분석**

## 검증 기준

### 기능 검증
- [ ] 2.0.0 버전 520MB 파일 다운로드 성공
- [ ] 모든 버전의 파일 다운로드 성공
- [ ] 인증된 사용자만 다운로드 가능
- [ ] 다운로드 즉시 시작 (1초 이내)

### 성능 검증
- [ ] 대용량 파일 (1GB+) 다운로드 테스트
- [ ] 동시 다운로드 10개 처리
- [ ] 네트워크 중단 후 재시도 성공

### 보안 검증
- [ ] JWT 토큰 없이 다운로드 시도 시 401 에러
- [ ] 만료된 토큰으로 접근 시 거부
- [ ] 다른 사용자 파일 접근 차단

## 리스크 및 대응

### 높은 리스크
1. **기존 다운로드 중단**: 시스템 변경 중 서비스 장애
   - 대응: 점진적 배포, 롤백 계획 수립

2. **성능 저하**: 토큰 생성/검증으로 인한 지연
   - 대응: 캐싱, 비동기 처리

### 중간 리스크
1. **브라우저 호환성**: 다양한 브라우저에서 동작 보장
   - 대응: 크로스 브라우저 테스트

2. **NAS 접근 실패**: Synology API 장애 시 fallback
   - 대응: 다단계 fallback 체인 구현

## 성공 메트릭

### 즉시 측정 가능한 메트릭
- 다운로드 성공률: 95% 이상
- 다운로드 시작 시간: 평균 1초 이하
- 401 에러 발생률: 0%

### 장기 메트릭
- 사용자 만족도 개선
- 고객 지원 요청 감소
- 시스템 안정성 향상

## 결론

현재 Harbor의 파일 다운로드 시스템은 아키텍처 불일치와 인증 메커니즘 문제로 인해 사용자 경험이 저하되고 있습니다. 이 PRD에서 제시한 통합 다운로드 시스템과 임시 토큰 방식을 통해 근본적인 문제를 해결하고, 즉시 다운로드가 가능한 안정적인 시스템을 구축할 수 있습니다.

가장 중요한 것은 Phase 1의 근본 문제 해결이며, 이를 통해 코드 수정사항이 확실히 반영되고 인증이 정상 동작하는 기반을 마련해야 합니다.